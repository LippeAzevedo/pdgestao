<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PD Gestão - App Híbrido</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega o jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Carrega os Ícones (Lucide) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <style>
        /* CSS para ocultar o spinner em campos de número */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }
        
        /* Estilos para Impressão Térmica */
        @media print {
            body > *, #app > * {
                display: none !important;
            }
            #app {
                display: block !important;
            }
            #receipt-print-area {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
            }
        }
        
        /* Utilitário para transição suave do menu */
        .sidebar-transition {
            transition-property: transform, opacity, visibility;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 300ms;
        }
    </style>
    
    <script>
        // Configuração do tema do Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': {
                            50: '#FFF8F9',
                            100: '#FDEEFO',
                            200: '#FADAE0',
                            300: '#F4BCC6',
                            400: '#E993A3',
                            500: '#DA647A',
                            600: '#C52A35', // Cor principal
                            700: '#A41F32',
                            800: '#8A1F2F',
                            900: '#75202E',
                            950: '#400D15',
                        },
                        'secondary': {
                            50: '#F5F3FF',
                            100: '#EDE9FE',
                            200: '#DDD6FE',
                            300: '#C4B5FD',
                            400: '#A78BFA',
                            500: '#8B5CF6',
                            600: '#7C3AED', // Cor secundária
                            700: '#6D28D9',
                            800: '#5B21B6',
                            900: '#4C1D95',
                            950: '#2E1065',
                        },
                        'pastel-bg': '#FFFBF7', // Fundo de página super suave
                        'pastel-card': '#FFFFFF', // Fundo dos cards
                        'pastel-text': '#5C4033', // Texto principal (escuro, mas suave)
                        'pastel-text-light': '#8C7A6B', // Texto secundário
                    }
                }
            }
        }
    </script>
</head>
<body class="h-full bg-pastel-bg text-pastel-text font-sans antialiased">

    <!-- Tela de Login (Fixa) -->
    <div id="loginPage" class="fixed inset-0 z-50 flex h-full w-full flex-col items-center justify-center bg-pastel-bg p-4 transition-opacity duration-300">
        <div class="w-full max-w-sm">
            <h1 class="text-center text-3xl font-bold text-primary-600">PD Gestão</h1>
            <p class="mb-6 text-center text-pastel-text-light">Bem-vinda de volta!</p>
            
            <form id="loginForm" class="rounded-xl bg-pastel-card p-6 shadow-lg">
                <div class="mb-4">
                    <label for="password" class="mb-1 block text-sm font-medium text-pastel-text-light">Senha</label>
                    <input type="password" id="password" class="w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600" required>
                </div>
                <p id="loginError" class="mb-4 hidden text-center text-sm text-red-600"></p>
                <button type="submit" class="w-full rounded-lg bg-primary-600 px-4 py-2 font-bold text-white shadow-md transition hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-opacity-50">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- Conteúdo Principal do App (Oculto até o login) -->
    <div id="app" class="hidden h-full">
        <!-- Cabeçalho (Fixo no Topo) -->
        <header class="sticky top-0 z-30 w-full bg-pastel-card/80 shadow-sm backdrop-blur-md">
            <div class="mx-auto flex max-w-4xl items-center justify-between px-4 py-3">
                <!-- Botão do Menu Hambúrguer -->
                <button id="menuBtn" class="rounded-lg p-2 text-primary-600 hover:bg-primary-50 focus:outline-none">
                    <i data-lucide="menu" class="h-6 w-6"></i>
                </button>
                
                <h1 id="pageTitle" class="text-center text-xl font-bold text-primary-600">Início</h1>
                
                <!-- Espaçador para manter o título centralizado -->
                <div class="w-10"></div> 
            </div>
        </header>

        <!-- Menu Lateral (Sidebar) -->
        <div id="sidebarOverlay" class="fixed inset-0 z-40 hidden bg-black/50 transition-opacity opacity-0 duration-300"></div>
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 -translate-x-full bg-pastel-card shadow-2xl sidebar-transition">
            <div class="flex h-full flex-col">
                <!-- Header do Menu -->
                <div class="flex items-center justify-between border-b border-gray-100 p-4 bg-primary-50">
                    <h2 class="text-xl font-bold text-primary-600">PD Gestão</h2>
                    <button id="closeMenuBtn" class="rounded-full p-1 text-pastel-text-light hover:bg-white hover:text-primary-600 focus:outline-none">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
                
                <!-- Itens de Navegação -->
                <nav id="sidebarNav" class="flex-1 overflow-y-auto p-4 space-y-1">
                    <!-- Inserido via JS -->
                </nav>
                
                <!-- Footer do Menu (Logout) -->
                <div class="border-t border-gray-100 p-4 bg-gray-50">
                    <button id="sidebarLogoutBtn" class="flex w-full items-center space-x-3 rounded-lg px-4 py-3 text-red-500 hover:bg-red-50 transition-colors">
                        <i data-lucide="log-out" class="h-5 w-5"></i>
                        <span class="font-medium">Sair do Sistema</span>
                    </button>
                    <p class="mt-2 text-center text-xs text-pastel-text-light">Versão 1.2.0</p>
                </div>
            </div>
        </aside>

        <!-- Container das Páginas -->
        <main class="mx-auto w-full max-w-4xl px-4 py-5">
            
            <!-- Página: Início (Dashboard) -->
            <div id="page-inicio" class="page space-y-6">
                <!-- Agendamentos Pendentes -->
                <div>
                    <h2 class="mb-3 text-lg font-semibold text-pastel-text">Agendamentos Pendentes</h2>
                    <div id="dashboard-pendentes" class="space-y-4">
                        <!-- JS irá preencher aqui -->
                    </div>
                </div>
                
                <!-- Histórico de Agendamentos -->
                <div>
                    <h2 class="mb-3 text-lg font-semibold text-pastel-text">Histórico</h2>
                    <div id="dashboard-historico" class="space-y-4">
                        <!-- JS irá preencher aqui -->
                    </div>
                </div>
            </div>

            <!-- Página: Agendar -->
            <div id="page-agendar" class="page hidden">
                <form id="agendamentoForm" class="space-y-4 rounded-xl bg-pastel-card p-4 shadow-lg sm:p-6">
                    <!-- Cliente -->
                    <div>
                        <label for="agendamentoCliente" class="mb-1 block text-sm font-medium text-pastel-text-light">Cliente</label>
                        <select id="agendamentoCliente" class="w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600" required>
                            <option value="" disabled selected>Selecione um cliente...</option>
                            <!-- JS irá preencher os clientes -->
                        </select>
                    </div>

                    <!-- Data -->
                    <div>
                        <label for="agendamentoData" class="mb-1 block text-sm font-medium text-pastel-text-light">Data e Hora</label>
                        <input type="datetime-local" id="agendamentoData" class="w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600" required>
                    </div>

                    <!-- Adicionar Serviços -->
                    <div class="space-y-3 rounded-lg border border-gray-200 p-3">
                        <h3 class="font-semibold text-pastel-text">Serviços</h3>
                        <div class="flex space-x-2">
                            <select id="agendamentoServicoSelect" class="w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600">
                                <option value="" disabled selected>Selecione um serviço...</option>
                                <!-- JS irá preencher os serviços -->
                            </select>
                            <button type="button" id="addServicoBtn" class="flex-shrink-0 rounded-lg bg-secondary-600 px-3 py-2 font-bold text-white shadow-sm transition hover:bg-secondary-700">
                                <i data-lucide="plus" class="h-5 w-5"></i>
                            </button>
                        </div>
                        <ul id="agendamentoServicosList" class="space-y-2 pt-2">
                            <!-- JS irá preencher os serviços adicionados -->
                        </ul>
                        <p id="agendamentoServicosError" class="hidden text-sm text-red-600">Adicione pelo menos um serviço.</p>
                    </div>

                    <!-- Desconto -->
                    <div class="grid grid-cols-3 gap-2">
                        <div class="col-span-2">
                            <label for="agendamentoDesconto" class="mb-1 block text-sm font-medium text-pastel-text-light">Desconto</label>
                            <input type="number" id="agendamentoDesconto" step="0.01" class="w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600" placeholder="0.00">
                        </div>
                        <div>
                            <label for="agendamentoDescontoTipo" class="mb-1 block text-sm font-medium text-pastel-text-light">Tipo</label>
                            <select id="agendamentoDescontoTipo" class="w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600">
                                <option value="dinheiro">R$</option>
                                <option value="porcentagem">%</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Valor Total -->
                    <div class="pt-2">
                        <span class="text-sm font-medium text-pastel-text-light">Valor Final:</span>
                        <span id="agendamentoValorFinal" class="ml-2 text-xl font-bold text-primary-700">R$ 0,00</span>
                    </div>

                    <input type="hidden" id="agendamentoEditId">

                    <button type="submit" class="w-full rounded-lg bg-primary-600 px-4 py-2.5 font-bold text-white shadow-md transition hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-opacity-50">
                        Salvar Agendamento
                    </button>
                    <button type="button" id="cancelEditBtn" class="hidden w-full rounded-lg bg-gray-500 px-4 py-2.5 font-bold text-white shadow-md transition hover:bg-gray-600">
                        Cancelar Edição
                    </button>
                </form>
            </div>
            
            <!-- Página: Caixa -->
            <div id="page-caixa" class="page hidden space-y-6">
                <!-- Nova Venda -->
                <form id="caixaForm" class="space-y-4 rounded-xl bg-pastel-card p-4 shadow-lg sm:p-6">
                    <h2 class="text-lg font-semibold text-pastel-text">Nova Venda (Caixa)</h2>
                    
                    <!-- Adicionar Produtos -->
                    <div class="space-y-3 rounded-lg border border-gray-200 p-3">
                        <h3 class="font-semibold text-pastel-text">Adicionar Produto</h3>
                        <div class="flex space-x-2">
                            <select id="caixaProdutoSelect" class="w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600">
                                <option value="" disabled selected>Selecione um produto...</option>
                                <!-- JS irá preencher os produtos -->
                            </select>
                            <input type="number" id="caixaQtdInput" value="1" min="1" class="w-20 rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-center text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600">
                            <button type="button" id="caixaAddBtn" class="flex-shrink-0 rounded-lg bg-secondary-600 px-3 py-2 font-bold text-white shadow-sm transition hover:bg-secondary-700">
                                <i data-lucide="plus" class="h-5 w-5"></i>
                            </button>
                        </div>
                        <p id="caixaEstoqueError" class="hidden text-sm text-red-600">Quantidade indisponível no estoque.</p>
                        
                        <h3 class="pt-4 font-semibold text-pastel-text">Carrinho</h3>
                        <ul id="caixaItensList" class="space-y-2 pt-2">
                            <li class="text-center text-sm text-pastel-text-light">Nenhum produto adicionado.</li>
                        </ul>
                    </div>
                    
                    <!-- Valor Total -->
                    <div class="pt-2">
                        <span class="text-sm font-medium text-pastel-text-light">Valor Final:</span>
                        <span id="caixaValorFinal" class="ml-2 text-xl font-bold text-primary-700">R$ 0,00</span>
                    </div>

                    <button type="submit" class="w-full rounded-lg bg-primary-600 px-4 py-2.5 font-bold text-white shadow-md transition hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-opacity-50">
                        Finalizar Venda
                    </button>
                </form>
            </div>

            <!-- Página: Clientes -->
            <div id="page-clientes" class="page hidden space-y-6">
                <!-- Cadastrar/Editar Cliente -->
                <form id="clienteForm" class="space-y-4 rounded-xl bg-pastel-card p-4 shadow-lg sm:p-6">
                    <h2 id="clienteFormTitle" class="text-lg font-semibold text-pastel-text">Novo Cliente</h2>
                    <input type="hidden" id="clienteEditId">
                    <div>
                        <label for="clienteNome" class="mb-1 block text-sm font-medium text-pastel-text-light">Nome</label>
                        <input type="text" id="clienteNome" class="w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600" required>
                    </div>
                    <div>
                        <label for="clienteTelefone" class="mb-1 block text-sm font-medium text-pastel-text-light">Telefone</label>
                        <input type="tel" id="clienteTelefone" class="w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600" placeholder="(XX) 9XXXX-XXXX">
                    </div>
                    <div>
                        <label for="clienteNascimento" class="mb-1 block text-sm font-medium text-pastel-text-light">Data de Nascimento</label>
                        <input type="date" id="clienteNascimento" class="w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600">
                    </div>
                    <button type="submit" id="clienteSubmitBtn" class="w-full rounded-lg bg-primary-600 px-4 py-2.5 font-bold text-white shadow-md transition hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-opacity-50">
                        Salvar Cliente
                    </button>
                    <button type="button" id="clienteCancelEditBtn" class="hidden w-full rounded-lg bg-gray-500 px-4 py-2.5 font-bold text-white shadow-md transition hover:bg-gray-600">
                        Cancelar Edição
                    </button>
                </form>
                
                <!-- Próximos Aniversários -->
                <div>
                    <h2 class="mb-3 text-lg font-semibold text-pastel-text">Próximos Aniversários</h2>
                    <div id="aniversariosLista" class="space-y-3">
                        <!-- JS preenche aqui -->
                    </div>
                </div>

                <!-- Lista de Clientes -->
                <div>
                    <h2 class="mb-3 text-lg font-semibold text-pastel-text">Todos os Clientes</h2>
                    <input type="text" id="filtroClientes" class="mb-3 w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600" placeholder="Buscar cliente...">
                    <div id="clientesLista" class="space-y-3">
                        <!-- JS preenche aqui -->
                    </div>
                </div>
            </div>
            
            <!-- Página: Serviços -->
            <div id="page-servicos" class="page hidden space-y-6">
                <!-- Cadastrar Serviço -->
                <form id="servicoForm" class="space-y-4 rounded-xl bg-pastel-card p-4 shadow-lg sm:p-6">
                    <h2 class="text-lg font-semibold text-pastel-text">Novo Serviço</h2>
                    <div>
                        <label for="servicoNome" class="mb-1 block text-sm font-medium text-pastel-text-light">Nome do Serviço</label>
                        <input type="text" id="servicoNome" class="w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600" required>
                    </div>
                    <div>
                        <label for="servicoPreco" class="mb-1 block text-sm font-medium text-pastel-text-light">Preço (R$)</label>
                        <input type="number" id="servicoPreco" step="0.01" class="w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600" required placeholder="0.00">
                    </div>
                    <button type="submit" class="w-full rounded-lg bg-primary-600 px-4 py-2.5 font-bold text-white shadow-md transition hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-opacity-50">
                        Salvar Serviço
                    </button>
                </form>
                
                <!-- Lista de Serviços -->
                <div>
                    <h2 class="mb-3 text-lg font-semibold text-pastel-text">Serviços Cadastrados</h2>
                    <div id="servicosLista" class="space-y-3">
                        <!-- JS irá preencher aqui -->
                    </div>
                </div>
            </div>

            <!-- Página: Estoque -->
            <div id="page-estoque" class="page hidden space-y-6">
                <!-- Cadastrar/Editar Produto -->
                <form id="estoqueForm" class="space-y-4 rounded-xl bg-pastel-card p-4 shadow-lg sm:p-6">
                    <h2 id="estoqueFormTitle" class="text-lg font-semibold text-pastel-text">Novo Produto</h2>
                    <input type="hidden" id="produtoEditId">
                    <div>
                        <label for="produtoNome" class="mb-1 block text-sm font-medium text-pastel-text-light">Nome do Produto</label>
                        <input type="text" id="produtoNome" class="w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600" required>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label for="produtoQtd" class="mb-1 block text-sm font-medium text-pastel-text-light">Quantidade</label>
                            <input type="number" id="produtoQtd" class="w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600" required placeholder="0">
                        </div>
                        <div>
                            <label for="produtoPreco" class="mb-1 block text-sm font-medium text-pastel-text-light">Preço (R$)</label>
                            <input type="number" id="produtoPreco" step="0.01" class="w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600" required placeholder="0.00">
                        </div>
                    </div>
                    <button type="submit" id="estoqueSubmitBtn" class="w-full rounded-lg bg-primary-600 px-4 py-2.5 font-bold text-white shadow-md transition hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-opacity-50">
                        Salvar Produto
                    </button>
                    <button type="button" id="estoqueCancelEditBtn" class="hidden w-full rounded-lg bg-gray-500 px-4 py-2.5 font-bold text-white shadow-md transition hover:bg-gray-600">
                        Cancelar Edição
                    </button>
                </form>
                
                <!-- Lista de Produtos -->
                <div>
                    <h2 class="mb-3 text-lg font-semibold text-pastel-text">Produtos em Estoque</h2>
                    <input type="text" id="filtroEstoque" class="mb-3 w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600" placeholder="Buscar produto...">
                    <div id="estoqueLista" class="space-y-3">
                        <!-- JS irá preencher aqui -->
                    </div>
                </div>
            </div>
            
            <!-- Página: Relatórios -->
            <div id="page-relatorios" class="page hidden space-y-6">
                <!-- Relatório por Período -->
                <div class="rounded-xl bg-pastel-card p-4 shadow-lg sm:p-6">
                    <h2 class="mb-3 text-lg font-semibold text-pastel-text">Ganhos por Período</h2>
                    <div class="mb-3 grid grid-cols-1 gap-3 sm:grid-cols-2">
                        <div>
                            <label for="relatorioInicio" class="mb-1 block text-sm font-medium text-pastel-text-light">De:</label>
                            <input type="date" id="relatorioInicio" class="w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600">
                        </div>
                        <div>
                            <label for="relatorioFim" class="mb-1 block text-sm font-medium text-pastel-text-light">Até:</label>
                            <input type="date" id="relatorioFim" class="w-full rounded-lg border border-gray-300 bg-primary-50 px-3 py-2 text-pastel-text focus:border-primary-600 focus:outline-none focus:ring-1 focus:ring-primary-600">
                        </div>
                    </div>
                    <button id="gerarRelatorioBtn" class="mb-4 w-full rounded-lg bg-secondary-600 px-4 py-2.5 font-bold text-white shadow-md transition hover:bg-secondary-700">
                        Gerar Relatório
                    </button>
                    
                    <div id="relatorioResultado" class="hidden space-y-2 rounded-lg bg-primary-50 p-4">
                        <p class="flex justify-between">
                            <span class="text-pastel-text-light">Período:</span>
                            <span id="relatorioPeriodo" class="font-medium text-pastel-text"></span>
                        </p>
                        <p class="flex justify-between">
                            <span class="text-pastel-text-light">Agendamentos Concluídos:</span>
                            <span id="relatorioAgendamentos" class="font-medium text-pastel-text"></span>
                        </p>
                        <p class="flex justify-between">
                            <span class="text-pastel-text-light">Vendas (Caixa):</span>
                            <span id="relatorioVendas" class="font-medium text-pastel-text"></span>
                        </p>
                        <p class="flex justify-between border-t border-primary-200 pt-2">
                            <span class="text-lg font-semibold text-pastel-text">Total Faturado:</span>
                            <span id="relatorioTotal" class="text-lg font-bold text-primary-700"></span>
                        </p>
                    </div>
                </div>
                
                <!-- Ranking Anual -->
                <div class="rounded-xl bg-pastel-card p-4 shadow-lg sm:p-6">
                    <h2 class="mb-3 text-lg font-semibold text-pastel-text">
                        Ranking Anual de Clientes
                    </h2>
                    <p id="rankingAno" class="mb-3 text-sm text-pastel-text-light"></p>
                    <div id="rankingLista" class="space-y-3">
                        <!-- JS preenche aqui -->
                    </div>
                </div>
            </div>

            <!-- Página: Backup -->
            <div id="page-backup" class="page hidden space-y-6">
                <!-- Exportar -->
                <div class="rounded-xl bg-pastel-card p-4 shadow-lg sm:p-6">
                    <h2 class="mb-3 text-lg font-semibold text-pastel-text">Exportar Dados (Backup)</h2>
                    <p class="mb-3 text-sm text-pastel-text-light">Salve um arquivo de segurança com todos os seus dados. Guarde-o em local seguro.</p>
                    <button id="backupBtn" class="w-full rounded-lg bg-primary-600 px-4 py-2.5 font-bold text-white shadow-md transition hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-opacity-50">
                        Salvar Backup
                    </button>
                </div>
                
                <!-- Importar -->
                <div class="rounded-xl bg-pastel-card p-4 shadow-lg sm:p-6">
                    <h2 class="mb-3 text-lg font-semibold text-pastel-text">Importar Dados (Restaurar)</h2>
                    <p class="mb-3 text-sm text-red-600">Atenção: Isso irá apagar TODOS os dados atuais e substituí-los pelos dados do arquivo.</p>
                    <input type="file" id="restoreInput" class="mb-3 block w-full text-sm text-pastel-text-light file:mr-4 file:rounded-lg file:border-0 file:bg-secondary-100 file:px-4 file:py-2 file:text-sm file:font-semibold file:text-secondary-700 hover:file:bg-secondary-200" accept=".json">
                    <button id="restoreBtn" class="w-full rounded-lg bg-red-600 px-4 py-2.5 font-bold text-white shadow-md transition hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-opacity-50">
                        Restaurar Backup
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal de Confirmação (Genérico) -->
    <div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-4 transition-opacity">
        <div class="w-full max-w-sm rounded-xl bg-pastel-card p-6 shadow-2xl">
            <h3 id="modalTitle" class="mb-3 text-lg font-bold text-pastel-text"></h3>
            <p id="modalMessage" class="mb-6 text-sm text-pastel-text-light"></p>
            <div class="flex justify-end space-x-3">
                <button id="modalCancel" class="rounded-lg border border-gray-300 bg-white px-4 py-2 font-medium text-pastel-text transition hover:bg-gray-50">Cancelar</button>
                <button id="modalConfirm" class="rounded-lg bg-red-600 px-4 py-2 font-bold text-white transition hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Sucesso de Venda (Específico) -->
    <div id="vendaSuccessModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-4 transition-opacity">
        <div class="w-full max-w-sm rounded-xl bg-pastel-card p-6 shadow-2xl">
            <h3 class="mb-3 text-lg font-bold text-green-600">Venda Finalizada!</h3>
            <p class="mb-6 text-sm text-pastel-text-light">A venda foi registrada e o estoque atualizado. Deseja gerar um recibo?</p>
            <div class="flex flex-col space-y-3">
                <button id="vendaPdfBtn" class="w-full rounded-lg bg-primary-600 px-4 py-2.5 font-bold text-white shadow-md transition hover:bg-primary-700">Baixar PDF</button>
                <button id="vendaPrintBtn" class="w-full rounded-lg bg-secondary-600 px-4 py-2.5 font-bold text-white shadow-md transition hover:bg-secondary-700">Imprimir Recibo (Térmica)</button>
                <button id="vendaCloseBtn" class="w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 font-medium text-pastel-text shadow-sm transition hover:bg-gray-50">Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Área de Impressão (Oculta) -->
    <div id="receipt-print-area" class="hidden" style="font-family: monospace; color: #000; width: 280px; padding: 10px;">
        <!-- Conteúdo do recibo será injetado aqui -->
    </div>


    <!-- SCRIPT PRINCIPAL DO APP -->
    <script>
        // Aguarda a página carregar completamente
        window.onload = () => {
            
            // --- VARIÁVEIS GLOBAIS ---
            const APP_PREFIX = 'pdGestao_';
            const SENHA_PADRAO = 'Denef3r';
            const { jsPDF } = window.jspdf;
            const lucide = window.lucide;
            
            // Estado principal do aplicativo
            let state = {
                servicos: [],
                estoque: [],
                agendamentos: [],
                clientes: [],
                vendas: [] // NOVO: Para o caixa
            };
            
            // Estados temporários
            let tempAgendamentoServicos = [];
            let editAgendamentoId = null;
            let editClienteId = null; // NOVO: Para editar cliente
            let editProdutoId = null; // NOVO: Para editar produto
            let tempVendaItens = []; // NOVO: Para o carrinho do caixa
            let lastVenda = null; // NOVO: Para guardar a última venda para recibos

            // Elementos da Interface (UI)
            const loginPage = document.getElementById('loginPage');
            const loginForm = document.getElementById('loginForm');
            const passwordInput = document.getElementById('password');
            const loginError = document.getElementById('loginError');
            const app = document.getElementById('app');
            const pageTitle = document.getElementById('pageTitle');
            const pages = document.querySelectorAll('.page');
            
            // Sidebar Elements
            const menuBtn = document.getElementById('menuBtn');
            const closeMenuBtn = document.getElementById('closeMenuBtn');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const sidebarNav = document.getElementById('sidebarNav');
            const sidebarLogoutBtn = document.getElementById('sidebarLogoutBtn');

            // Formulários
            const servicoForm = document.getElementById('servicoForm');
            const estoqueForm = document.getElementById('estoqueForm');
            const agendamentoForm = document.getElementById('agendamentoForm');
            const clienteForm = document.getElementById('clienteForm');
            const caixaForm = document.getElementById('caixaForm'); // NOVO

            // Listas
            const servicosLista = document.getElementById('servicosLista');
            const estoqueLista = document.getElementById('estoqueLista');
            const dashboardPendentes = document.getElementById('dashboard-pendentes');
            const dashboardHistorico = document.getElementById('dashboard-historico');
            const clientesLista = document.getElementById('clientesLista');
            const aniversariosLista = document.getElementById('aniversariosLista');
            const caixaItensList = document.getElementById('caixaItensList'); // NOVO

            // Filtros
            const filtroEstoque = document.getElementById('filtroEstoque');
            const filtroClientes = document.getElementById('filtroClientes');
            
            // Agendamento
            const agendamentoClienteSelect = document.getElementById('agendamentoCliente');
            const agendamentoServicoSelect = document.getElementById('agendamentoServicoSelect');
            const addServicoBtn = document.getElementById('addServicoBtn');
            const agendamentoServicosList = document.getElementById('agendamentoServicosList');
            const agendamentoServicosError = document.getElementById('agendamentoServicosError');
            const agendamentoDataInput = document.getElementById('agendamentoData');
            const agendamentoDescontoInput = document.getElementById('agendamentoDesconto');
            const agendamentoDescontoTipoSelect = document.getElementById('agendamentoDescontoTipo');
            const agendamentoValorFinal = document.getElementById('agendamentoValorFinal');
            const agendamentoEditIdInput = document.getElementById('agendamentoEditId');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            
            // Cliente Edição
            const clienteFormTitle = document.getElementById('clienteFormTitle');
            const clienteEditIdInput = document.getElementById('clienteEditId');
            const clienteSubmitBtn = document.getElementById('clienteSubmitBtn');
            const clienteCancelEditBtn = document.getElementById('clienteCancelEditBtn');
            
            // Estoque Edição
            const estoqueFormTitle = document.getElementById('estoqueFormTitle');
            const produtoEditIdInput = document.getElementById('produtoEditId');
            const produtoPrecoInput = document.getElementById('produtoPreco');
            const estoqueSubmitBtn = document.getElementById('estoqueSubmitBtn');
            const estoqueCancelEditBtn = document.getElementById('estoqueCancelEditBtn');

            // Caixa
            const caixaProdutoSelect = document.getElementById('caixaProdutoSelect');
            const caixaQtdInput = document.getElementById('caixaQtdInput');
            const caixaAddBtn = document.getElementById('caixaAddBtn');
            const caixaEstoqueError = document.getElementById('caixaEstoqueError');
            const caixaValorFinal = document.getElementById('caixaValorFinal');

            // Backup
            const backupBtn = document.getElementById('backupBtn');
            const restoreBtn = document.getElementById('restoreBtn');
            const restoreInput = document.getElementById('restoreInput');
            
            // Relatórios
            const relatorioInicioInput = document.getElementById('relatorioInicio');
            const relatorioFimInput = document.getElementById('relatorioFim');
            const gerarRelatorioBtn = document.getElementById('gerarRelatorioBtn');
            const relatorioResultado = document.getElementById('relatorioResultado');
            const relatorioPeriodo = document.getElementById('relatorioPeriodo');
            const relatorioAgendamentos = document.getElementById('relatorioAgendamentos'); // Alterado
            const relatorioVendas = document.getElementById('relatorioVendas'); // NOVO
            const relatorioTotal = document.getElementById('relatorioTotal');
            const rankingAno = document.getElementById('rankingAno');
            const rankingLista = document.getElementById('rankingLista');

            // Modal Genérico
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalCancel = document.getElementById('modalCancel');
            const modalConfirm = document.getElementById('modalConfirm');
            let modalConfirmCallback = null;
            
            // Modal Sucesso Venda
            const vendaSuccessModal = document.getElementById('vendaSuccessModal');
            const vendaPdfBtn = document.getElementById('vendaPdfBtn');
            const vendaPrintBtn = document.getElementById('vendaPrintBtn');
            const vendaCloseBtn = document.getElementById('vendaCloseBtn');
            
            // Área de Impressão
            const receiptPrintArea = document.getElementById('receipt-print-area');

            
            // Navegação
            const navItems = [
                { id: 'inicio', label: 'Início', icon: 'Home' },
                { id: 'agendar', label: 'Agendar', icon: 'CalendarPlus' },
                { id: 'caixa', label: 'Caixa', icon: 'ShoppingCart' },
                { id: 'clientes', label: 'Clientes', icon: 'Users' },
                { id: 'servicos', label: 'Serviços', icon: 'Scissors' },
                { id: 'estoque', label: 'Estoque', icon: 'Archive' },
                { id: 'relatorios', label: 'Relatórios', icon: 'BarChart3' },
                { id: 'backup', label: 'Backup', icon: 'DatabaseBackup' },
            ];


            // --- FUNÇÕES PRINCIPAIS ---

            /**
             * Inicializa o aplicativo
             */
            function init() {
                // Configura os ícones
                lucide.createIcons();
                
                // Configura os ouvintes de evento (listeners)
                setupListeners();
                
                // Verifica o estado de login
                checkLoginState();
            }

            /**
             * Configura todos os ouvintes de evento da aplicação
             */
            function setupListeners() {
                // Login
                loginForm.addEventListener('submit', handleLogin);
                
                // Sidebar
                menuBtn.addEventListener('click', () => toggleMenu(true));
                closeMenuBtn.addEventListener('click', () => toggleMenu(false));
                sidebarOverlay.addEventListener('click', () => toggleMenu(false));
                sidebarLogoutBtn.addEventListener('click', handleLogout);
                createSidebarItems(); // Renderiza os itens do menu

                // Formulários
                servicoForm.addEventListener('submit', handleServicoSubmit);
                estoqueForm.addEventListener('submit', handleEstoqueSubmit);
                agendamentoForm.addEventListener('submit', handleAgendamentoSubmit);
                clienteForm.addEventListener('submit', handleClienteSubmit);
                caixaForm.addEventListener('submit', handleFinalizarVenda);
                
                // Botões de Agendamento
                addServicoBtn.addEventListener('click', handleAddServico);
                agendamentoServicosList.addEventListener('click', handleRemoveServico);
                agendamentoDescontoInput.addEventListener('input', updateValorFinal);
                agendamentoDescontoTipoSelect.addEventListener('change', updateValorFinal);
                cancelEditBtn.addEventListener('click', resetAgendamentoForm);

                // Botões do Caixa
                caixaAddBtn.addEventListener('click', handleCaixaAdd);
                caixaItensList.addEventListener('click', handleCaixaRemove);

                // Botões de Edição
                clienteCancelEditBtn.addEventListener('click', resetClienteForm);
                estoqueCancelEditBtn.addEventListener('click', resetEstoqueForm);

                // Listas
                servicosLista.addEventListener('click', handleServicoListClick);
                estoqueLista.addEventListener('click', handleEstoqueListClick);
                clientesLista.addEventListener('click', handleClienteListClick);
                dashboardPendentes.addEventListener('click', handleDashboardListClick);
                dashboardHistorico.addEventListener('click', handleDashboardListClick);
                
                // Filtros
                filtroEstoque.addEventListener('input', () => renderEstoque(filtroEstoque.value));
                filtroClientes.addEventListener('input', () => renderClientes(filtroClientes.value));

                // Backup
                backupBtn.addEventListener('click', handleBackup);
                restoreBtn.addEventListener('click', () => restoreInput.click()); // Aciona o input file
                restoreInput.addEventListener('change', handleRestore);
                
                // Relatórios
                gerarRelatorioBtn.addEventListener('click', renderRelatorioPeriodo);

                // Modal Genérico
                modalCancel.addEventListener('click', hideModal);
                modalConfirm.addEventListener('click', () => {
                    if (modalConfirmCallback) {
                        modalConfirmCallback();
                    }
                    hideModal();
                });
                
                // Modal Venda
                vendaPdfBtn.addEventListener('click', handleVendaPdf);
                vendaPrintBtn.addEventListener('click', handleVendaPrint);
                vendaCloseBtn.addEventListener('click', hideVendaSuccessModal);
            }
            
            // --- LOGIN E AUTENTICAÇÃO ---

            /**
             * Verifica se o usuário já fez o primeiro login
             */
            function checkLoginState() {
                const loggedIn = localStorage.getItem(APP_PREFIX + 'loggedIn');
                
                if (loggedIn === 'true') {
                    // Usuário já logado, mas ainda precisa da senha
                    loginPage.classList.remove('opacity-0');
                    loginError.textContent = 'Sessão expirada. Faça login novamente.';
                    loginError.classList.remove('hidden');
                } else {
                    // Primeiro acesso ou deslogado
                    loginPage.classList.remove('opacity-0');
                    loginError.textContent = 'Use a senha padrão para entrar.';
                    loginError.classList.remove('hidden');
                }
            }

            /**
             * Lida com o submit do formulário de login
             */
            function handleLogin(e) {
                e.preventDefault();
                const senha = passwordInput.value;
                
                if (senha === SENHA_PADRAO) {
                    // Senha correta
                    localStorage.setItem(APP_PREFIX + 'loggedIn', 'true');
                    
                    // Esconde a tela de login e mostra o app
                    loginPage.classList.add('opacity-0', 'pointer-events-none');
                    app.classList.remove('hidden');
                    
                    // Carrega os dados e renderiza a página inicial
                    loadState();
                    showPage('inicio');
                    
                } else {
                    // Senha incorreta
                    loginError.textContent = 'Senha incorreta. Tente novamente.';
                    loginError.classList.remove('hidden');
                    passwordInput.value = '';
                }
            }

            // --- NAVEGAÇÃO E UI (SIDEBAR) ---

            /**
             * Abre ou fecha o menu lateral
             */
            function toggleMenu(show) {
                if (show) {
                    sidebarOverlay.classList.remove('hidden');
                    // Pequeno delay para permitir a transição de opacidade
                    setTimeout(() => {
                        sidebarOverlay.classList.remove('opacity-0');
                        sidebar.classList.remove('-translate-x-full');
                    }, 10);
                } else {
                    sidebar.classList.add('-translate-x-full');
                    sidebarOverlay.classList.add('opacity-0');
                    // Aguarda a transição antes de esconder
                    setTimeout(() => {
                        sidebarOverlay.classList.add('hidden');
                    }, 300);
                }
            }

            /**
             * Cria os botões da barra de navegação lateral
             */
            function createSidebarItems() {
                sidebarNav.innerHTML = ''; 
                
                // Converte CamelCase para kebab-case para o data-lucide
                const toKebabCase = (str) => str.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();

                navItems.forEach(item => {
                    const iconName = item.icon;
                    const button = document.createElement('button');
                    button.dataset.page = item.id;
                    button.className = `sidebar-btn w-full flex items-center space-x-3 rounded-lg px-4 py-3 text-left font-medium transition-colors duration-200 ${item.id === 'inicio' ? 'bg-primary-50 text-primary-600' : 'text-pastel-text hover:bg-secondary-50'}`;
                    
                    const kebabIconName = toKebabCase(iconName);
                    const iconElement = `<i data-lucide="${kebabIconName}" class="h-5 w-5"></i>`;
                    
                    button.innerHTML = `
                        ${iconElement}
                        <span>${item.label}</span>
                    `;
                    
                    // Adiciona evento de clique direto no botão gerado
                    button.addEventListener('click', () => {
                        showPage(item.id);
                        toggleMenu(false); // Fecha o menu ao clicar
                    });
                    
                    sidebarNav.appendChild(button);
                });
                
                // Recria os ícones Lucide
                lucide.createIcons();
            }
            
            // Não precisamos mais de handleNavClick global pois adicionamos listeners individuais
            // function handleNavClick(e) { ... }

            /**
             * Lida com o logout do usuário
             */
            function handleLogout() {
                toggleMenu(false);
                showModal('Confirmar Saída', 'Tem certeza que deseja sair? Seus dados estão salvos no navegador.', () => {
                    localStorage.removeItem(APP_PREFIX + 'loggedIn');
                    // Recarrega a página para voltar à tela de login
                    window.location.reload();
                });
            }

            /**
             * Mostra a página solicitada e atualiza o título e a navegação
             */
            function showPage(pageId) {
                // Esconde todas as páginas
                pages.forEach(page => page.classList.add('hidden'));
                
                // Mostra a página correta
                const activePage = document.getElementById(`page-${pageId}`);
                if (activePage) {
                    activePage.classList.remove('hidden');
                }
                
                // Atualiza o título
                const navItem = navItems.find(item => item.id === pageId);
                pageTitle.textContent = navItem ? navItem.label : 'PD Gestão';
                
                // Atualiza o estado da barra de navegação lateral
                document.querySelectorAll('.sidebar-btn').forEach(btn => {
                    if (btn.dataset.page === pageId) {
                        btn.classList.add('bg-primary-50', 'text-primary-600');
                        btn.classList.remove('text-pastel-text', 'hover:bg-secondary-50');
                    } else {
                        btn.classList.remove('bg-primary-50', 'text-primary-600');
                        btn.classList.add('text-pastel-text', 'hover:bg-secondary-50');
                    }
                });

                // Ações específicas ao mostrar a página
                if (pageId === 'agendar') {
                    populateClienteSelect();
                    populateServicoSelect();
                    if (!editAgendamentoId) {
                        resetAgendamentoForm();
                    }
                } else if (pageId === 'inicio') {
                    renderDashboard();
                } else if (pageId === 'clientes') {
                    renderClientes();
                    renderAniversarios();
                } else if (pageId === 'servicos') {
                    renderServicos();
                } else if (pageId === 'estoque') {
                    renderEstoque();
                } else if (pageId === 'relatorios') {
                    renderRelatorios();
                } else if (pageId === 'caixa') {
                    populateCaixaProdutoSelect();
                    resetCaixaForm();
                }
                
                // Rola para o topo da página
                window.scrollTo(0, 0);
            }
            
            /**
             * Exibe o modal de confirmação
             */
            function showModal(title, message, onConfirm) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalConfirmCallback = onConfirm;
                
                // Customiza o botão de confirmar
                if (title.toLowerCase().includes('apagar') || title.toLowerCase().includes('cancelar') || title.toLowerCase().includes('saída')) {
                    modalConfirm.className = "rounded-lg bg-red-600 px-4 py-2 font-bold text-white transition hover:bg-red-700";
                    modalConfirm.textContent = "Confirmar";
                } else {
                    modalConfirm.className = "rounded-lg bg-primary-600 px-4 py-2 font-bold text-white transition hover:bg-primary-700";
                    modalConfirm.textContent = "OK";
                }
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
            
            /**
             * Esconde o modal de confirmação
             */
            function hideModal() {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                modalConfirmCallback = null;
            }
            
            // NOVO: Modais de sucesso de venda
            function showVendaSuccessModal(venda) {
                lastVenda = venda; // Salva a venda para os botões de recibo
                vendaSuccessModal.classList.remove('hidden');
                vendaSuccessModal.classList.add('flex');
            }
            
            function hideVendaSuccessModal() {
                vendaSuccessModal.classList.add('hidden');
                vendaSuccessModal.classList.remove('flex');
                lastVenda = null;
            }
            
            function handleVendaPdf() {
                if(lastVenda) generatePDFVenda(lastVenda);
                hideVendaSuccessModal();
            }
            
            function handleVendaPrint() {
                if(lastVenda) printThermalReceipt(lastVenda);
                hideVendaSuccessModal();
            }

            
            /**
             * Formata um valor numérico para moeda BRL
             */
            function formatCurrency(value) {
                if (isNaN(value)) value = 0;
                return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }
            
            /**
             * Formata data para exibição (ex: 14 de Nov, 14:30)
             */
            function formatDateTime(dateString) {
                const date = new Date(dateString);
                return date.toLocaleString('pt-BR', { 
                    day: 'numeric', 
                    month: 'short', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
            
            /**
             * Formata data para exibição (ex: 14 de Novembro)
             */
            function formatDate(date) {
                return date.toLocaleDateString('pt-BR', { 
                    day: 'numeric', 
                    month: 'long'
                });
            }
            
            /**
             * Formata data para input (YYYY-MM-DD)
             */
            function formatDateForInput(date) {
                const offset = date.getTimezoneOffset();
                const localDate = new Date(date.getTime() - (offset*60*1000));
                return localDate.toISOString().split('T')[0];
            }
            
            /**
             * Formata datetime para input (YYYY-MM-DDTHH:MM)
             */
            function formatDateTimeForInput(dateString) {
                const date = new Date(dateString);
                const offset = date.getTimezoneOffset();
                // Subtrai o offset para exibir a hora local correta no input
                const localDate = new Date(date.getTime() - (offset * 60 * 1000));
                return localDate.toISOString().slice(0, 16);
            }
            
            /**
             * Gera um ID único
             */
            function generateId() {
                return '_' + Math.random().toString(36).substr(2, 9);
            }
            
            // --- GERENCIAMENTO DE ESTADO (LOCALSTORAGE) ---

            /**
             * Carrega o estado do localStorage
             */
            function loadState() {
                const storedState = localStorage.getItem(APP_PREFIX + 'state');
                if (storedState) {
                    state = JSON.parse(storedState);
                    // Garante que o estado tenha todas as chaves
                    state.servicos = state.servicos || [];
                    state.estoque = state.estoque || [];
                    state.agendamentos = state.agendamentos || [];
                    state.clientes = state.clientes || [];
                    state.vendas = state.vendas || []; // NOVO
                    
                    // **MUITO IMPORTANTE: Migra os dados antigos**
                    migrateData();
                }
            }

            /**
             * Salva o estado atual no localStorage
             */
            function saveState() {
                localStorage.setItem(APP_PREFIX + 'state', JSON.stringify(state));
            }
            
            /**
             * MIGRAÇÃO DE DADOS: Converte agendamentos antigos (serviço único) para o novo formato (múltiplos serviços)
             */
            function migrateData(dataToMigrate = state) {
                let migrated = false;
                
                // Migração 1: Agendamentos
                dataToMigrate.agendamentos.forEach(ag => {
                    // Verifica se está no formato antigo (tem servicoId, mas não tem array servicos)
                    if (ag.servicoId && !ag.servicos) {
                        migrated = true;
                        
                        // Tenta encontrar o nome e valor do serviço original
                        let servicoNome = ag.servicoNome || 'Serviço Antigo'; // Fallback
                        let valorOriginal = ag.valorOriginal || ag.valorFinal || 0; // Fallback
                        
                        if (dataToMigrate.servicos && dataToMigrate.servicos.length > 0) {
                            const servico = dataToMigrate.servicos.find(s => s.id === ag.servicoId);
                            if (servico) {
                                servicoNome = servico.nome;
                                valorOriginal = ag.valorFinal + (ag.desconto || 0);
                            }
                        }

                        ag.servicos = [ { id: ag.servicoId, nome: servicoNome, valor: valorOriginal } ];
                        delete ag.servicoId;
                        delete ag.servicoNome;
                        delete ag.valorOriginal;
                    }
                    
                    // Garante que todo agendamento tenha um status (para dados antigos)
                    if (!ag.status) {
                        migrated = true;
                        const dataAg = new Date(ag.data);
                        ag.status = (dataAg < new Date()) ? 'concluido' : 'agendado';
                    }
                });
                
                // Migração 2: Estoque (adiciona 'preco' se não existir)
                dataToMigrate.estoque.forEach(p => {
                    if (p.preco === undefined) { // Usa 'undefined' para pegar 0 e null
                        migrated = true;
                        p.preco = 0; // Define um preço padrão
                    }
                });
                
                if (migrated) {
                    console.log("Dados migrados para o novo formato.");
                    if (dataToMigrate === state) {
                        saveState();
                    }
                }
                
                return dataToMigrate; // Retorna os dados migrados (útil para o backup)
            }


            // --- GERENCIAMENTO DE SERVIÇOS ---

            /**
             * Lida com o submit do formulário de serviço
             */
            function handleServicoSubmit(e) {
                e.preventDefault();
                const nome = document.getElementById('servicoNome').value;
                const preco = parseFloat(document.getElementById('servicoPreco').value);
                
                if (nome && preco > 0) {
                    state.servicos.push({ id: generateId(), nome, preco });
                    saveState();
                    renderServicos();
                    servicoForm.reset();
                }
            }

            /**
             * Renderiza a lista de serviços
             */
            function renderServicos() {
                servicosLista.innerHTML = '';
                if (state.servicos.length === 0) {
                    servicosLista.innerHTML = '<p class="text-center text-pastel-text-light">Nenhum serviço cadastrado.</p>';
                    return;
                }
                
                state.servicos.forEach(servico => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between rounded-lg bg-pastel-card p-4 shadow-sm';
                    item.innerHTML = `
                        <div>
                            <p class="font-medium text-pastel-text">${servico.nome}</p>
                            <p class="text-sm text-primary-600 font-semibold">${formatCurrency(servico.preco)}</p>
                        </div>
                        <button data-id="${servico.id}" class="delete-servico rounded-full p-2 text-red-500 transition hover:bg-red-100">
                            <i data-lucide="trash-2" class="h-5 w-5"></i>
                        </button>
                    `;
                    servicosLista.appendChild(item);
                });
                lucide.createIcons();
            }

            /**
             * Lida com cliques na lista de serviços (apagar)
             */
            function handleServicoListClick(e) {
                const deleteBtn = e.target.closest('.delete-servico');
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    showModal('Apagar Serviço', 'Tem certeza que deseja apagar este serviço? Esta ação não pode ser desfeita.', () => {
                        state.servicos = state.servicos.filter(s => s.id !== id);
                        saveState();
                        renderServicos();
                    });
                }
            }

            // --- GERENCIAMENTO DE ESTOQUE ---

            /**
             * Lida com o submit do formulário de estoque (Criar ou Editar)
             */
            function handleEstoqueSubmit(e) {
                e.preventDefault();
                const nome = document.getElementById('produtoNome').value;
                const qtd = parseInt(document.getElementById('produtoQtd').value);
                const preco = parseFloat(produtoPrecoInput.value);
                
                if (nome && qtd >= 0 && preco >= 0) {
                    if (editProdutoId) {
                        // Atualizar produto existente
                        const index = state.estoque.findIndex(p => p.id === editProdutoId);
                        if (index !== -1) {
                            state.estoque[index] = { id: editProdutoId, nome, qtd, preco };
                        }
                    } else {
                        // Criar novo produto
                        state.estoque.push({ id: generateId(), nome, qtd, preco });
                    }
                    saveState();
                    renderEstoque();
                    resetEstoqueForm();
                }
            }
            
            /**
             * Limpa e reseta o formulário de estoque
             */
            function resetEstoqueForm() {
                estoqueForm.reset();
                editProdutoId = null;
                produtoEditIdInput.value = '';
                estoqueFormTitle.textContent = 'Novo Produto';
                estoqueSubmitBtn.textContent = 'Salvar Produto';
                estoqueCancelEditBtn.classList.add('hidden');
            }
            
            /**
             * Preenche o formulário de estoque para edição
             */
            function fillEstoqueFormForEdit(produto) {
                editProdutoId = produto.id;
                produtoEditIdInput.value = produto.id;
                document.getElementById('produtoNome').value = produto.nome;
                document.getElementById('produtoQtd').value = produto.qtd;
                produtoPrecoInput.value = produto.preco;
                
                estoqueFormTitle.textContent = 'Editar Produto';
                estoqueSubmitBtn.textContent = 'Atualizar Produto';
                estoqueCancelEditBtn.classList.remove('hidden');
                
                // Rola para o topo para ver o formulário
                window.scrollTo(0, 0);
            }

            /**
             * Renderiza a lista de estoque
             */
            function renderEstoque(filtro = '') {
                estoqueLista.innerHTML = '';
                const filtroLower = filtro.toLowerCase();
                const produtosFiltrados = state.estoque.filter(p => p.nome.toLowerCase().includes(filtroLower));

                if (produtosFiltrados.length === 0) {
                    estoqueLista.innerHTML = '<p class="text-center text-pastel-text-light">Nenhum produto encontrado.</p>';
                    return;
                }
                
                produtosFiltrados.forEach(produto => {
                    const item = document.createElement('div');
                    item.className = 'rounded-lg bg-pastel-card p-4 shadow-sm';
                    item.innerHTML = `
                        <div class="flex flex-col items-start justify-between sm:flex-row sm:items-center">
                            <div>
                                <p class="font-medium text-pastel-text">${produto.nome}</p>
                                <p class="text-sm text-secondary-600">${formatCurrency(produto.preco)}</p>
                            </div>
                            <span class="mt-1 text-sm font-bold sm:mt-0 ${produto.qtd < 5 ? 'text-red-600' : 'text-primary-600'}">
                                ${produto.qtd} em estoque
                            </span>
                        </div>
                        <div class="mt-4 flex space-x-2 border-t border-gray-100 pt-3">
                            <button data-id="${produto.id}" class="edit-produto btn-sm flex-1 bg-blue-500 hover:bg-blue-600">
                                <i data-lucide="edit" class="mr-1 h-4 w-4"></i> Editar
                            </button>
                            <button data-id="${produto.id}" class="delete-produto btn-sm flex-1 bg-red-500 hover:bg-red-600">
                                <i data-lucide="trash-2" class="mr-1 h-4 w-4"></i> Apagar
                            </button>
                        </div>
                    `;
                    estoqueLista.appendChild(item);
                });
                lucide.createIcons();
            }
            
            /**
             * Lida com cliques na lista de estoque (apagar ou editar)
             */
            function handleEstoqueListClick(e) {
                const deleteBtn = e.target.closest('.delete-produto');
                const editBtn = e.target.closest('.edit-produto');
                
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    showModal('Apagar Produto', 'Tem certeza que deseja apagar este produto do estoque?', () => {
                        state.estoque = state.estoque.filter(p => p.id !== id);
                        saveState();
                        renderEstoque(filtroEstoque.value);
                    });
                }
                
                if (editBtn) {
                    const id = editBtn.dataset.id;
                    const produto = state.estoque.find(p => p.id === id);
                    if (produto) {
                        fillEstoqueFormForEdit(produto);
                    }
                }
            }
            
            // --- GERENCIAMENTO DE CLIENTES ---

            /**
             * Lida com o submit do formulário de cliente (Criar ou Editar)
             */
            function handleClienteSubmit(e) {
                e.preventDefault();
                const nome = document.getElementById('clienteNome').value;
                const telefone = document.getElementById('clienteTelefone').value;
                const nascimento = document.getElementById('clienteNascimento').value;
                
                if (nome) {
                    if (editClienteId) {
                        // Atualizar cliente
                        const index = state.clientes.findIndex(c => c.id === editClienteId);
                        if (index !== -1) {
                            state.clientes[index] = { id: editClienteId, nome, telefone, nascimento };
                        }
                    } else {
                        // Criar novo cliente
                        state.clientes.push({ id: generateId(), nome, telefone, nascimento });
                    }
                    
                    state.clientes.sort((a, b) => a.nome.localeCompare(b.nome)); // Mantém ordenado
                    saveState();
                    renderClientes();
                    renderAniversarios();
                    resetClienteForm();
                }
            }
            
            /**
             * Limpa e reseta o formulário de cliente
             */
            function resetClienteForm() {
                clienteForm.reset();
                editClienteId = null;
                clienteEditIdInput.value = '';
                clienteFormTitle.textContent = 'Novo Cliente';
                clienteSubmitBtn.textContent = 'Salvar Cliente';
                clienteCancelEditBtn.classList.add('hidden');
            }
            
            /**
             * Preenche o formulário de cliente para edição
             */
            function fillClienteFormForEdit(cliente) {
                editClienteId = cliente.id;
                clienteEditIdInput.value = cliente.id;
                document.getElementById('clienteNome').value = cliente.nome;
                document.getElementById('clienteTelefone').value = cliente.telefone;
                document.getElementById('clienteNascimento').value = cliente.nascimento;
                
                clienteFormTitle.textContent = 'Editar Cliente';
                clienteSubmitBtn.textContent = 'Atualizar Cliente';
                clienteCancelEditBtn.classList.remove('hidden');
                
                // Rola para o topo para ver o formulário
                window.scrollTo(0, 0);
            }

            /**
             * Renderiza a lista de clientes
             */
            function renderClientes(filtro = '') {
                clientesLista.innerHTML = '';
                const filtroLower = filtro.toLowerCase();
                const clientesFiltrados = state.clientes.filter(c => c.nome.toLowerCase().includes(filtroLower));

                if (clientesFiltrados.length === 0) {
                    clientesLista.innerHTML = '<p class="text-center text-pastel-text-light">Nenhum cliente encontrado.</p>';
                    return;
                }
                
                clientesFiltrados.forEach(cliente => {
                    const totalGasto = state.agendamentos
                        .filter(ag => ag.clienteId === cliente.id && ag.status === 'concluido')
                        .reduce((total, ag) => total + ag.valorFinal, 0);

                    const item = document.createElement('div');
                    item.className = 'rounded-lg bg-pastel-card p-4 shadow-sm';
                    item.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="font-medium text-pastel-text">${cliente.nome}</p>
                                <p class="text-sm text-pastel-text-light">${cliente.telefone || 'Sem telefone'}</p>
                                ${cliente.nascimento ? `<p class="text-sm text-pastel-text-light">Nasc: ${formatDate(new Date(cliente.nascimento))}</p>` : ''}
                                <p class="mt-1 text-sm text-secondary-600">Total Gasto: ${formatCurrency(totalGasto)}</p>
                            </div>
                            <div class="flex flex-col space-y-2 sm:flex-row sm:space-x-2 sm:space-y-0">
                                <button data-id="${cliente.id}" class="edit-cliente rounded-full p-2 text-blue-500 transition hover:bg-blue-100">
                                    <i data-lucide="edit-2" class="h-5 w-5"></i>
                                </button>
                                <button data-id="${cliente.id}" class="delete-cliente rounded-full p-2 text-red-500 transition hover:bg-red-100">
                                    <i data-lucide="trash-2" class="h-5 w-5"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    clientesLista.appendChild(item);
                });
                lucide.createIcons();
            }
            
            /**
             * Lida com cliques na lista de clientes (apagar ou editar)
             */
            function handleClienteListClick(e) {
                const deleteBtn = e.target.closest('.delete-cliente');
                const editBtn = e.target.closest('.edit-cliente');
                
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    showModal('Apagar Cliente', 'Tem certeza que deseja apagar este cliente? Isso NÃO apagará seus agendamentos passados.', () => {
                        state.clientes = state.clientes.filter(c => c.id !== id);
                        saveState();
                        renderClientes(filtroClientes.value);
                        renderAniversarios();
                    });
                }
                
                if (editBtn) {
                    const id = editBtn.dataset.id;
                    const cliente = state.clientes.find(c => c.id === id);
                    if(cliente) {
                        fillClienteFormForEdit(cliente);
                    }
                }
            }
            
            /**
             * Renderiza a lista de próximos aniversários
             */
            function renderAniversarios() {
                aniversariosLista.innerHTML = '';
                const hoje = new Date();
                
                const aniversariantes = state.clientes
                    .filter(c => c.nascimento) // Apenas clientes com data de nascimento
                    .map(c => {
                        const dataNasc = new Date(c.nascimento); // Formato YYYY-MM-DD
                        const dataNascLocal = new Date(dataNasc.getUTCFullYear(), dataNasc.getUTCMonth(), dataNasc.getUTCDate());
                        const diaNasc = dataNascLocal.getDate();
                        const mesNasc = dataNascLocal.getMonth();
                        
                        let proximoAniversario = new Date(hoje.getFullYear(), mesNasc, diaNasc);
                        if (proximoAniversario < hoje) {
                            proximoAniversario.setFullYear(hoje.getFullYear() + 1);
                        }
                        const diffTime = proximoAniversario.getTime() - hoje.getTime();
                        const diffDias = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        return { ...c, dataNascLocal, diffDias };
                    })
                    .filter(c => c.diffDias <= 30) // Apenas nos próximos 30 dias
                    .sort((a, b) => a.diffDias - b.diffDias); // Ordena pelo mais próximo
                    
                if (aniversariantes.length === 0) {
                    aniversariosLista.innerHTML = '<p class="text-center text-pastel-text-light">Nenhum aniversário nos próximos 30 dias.</p>';
                    return;
                }
                
                aniversariantes.forEach(cliente => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between rounded-lg bg-pastel-card p-3 shadow-sm';
                    item.innerHTML = `
                        <div>
                            <p class="font-medium text-pastel-text">${cliente.nome}</p>
                            <p class="text-sm text-pastel-text-light">${formatDate(cliente.dataNascLocal)}</p>
                        </div>
                        <span class="text-sm font-semibold text-primary-600">${cliente.diffDias === 0 ? 'HOJE!' : `em ${cliente.diffDias} dias`}</span>
                    `;
                    aniversariosLista.appendChild(item);
                });
            }

            /**
             * Popula o select de clientes no formulário de agendamento
             */
            function populateClienteSelect() {
                agendamentoClienteSelect.innerHTML = '<option value="" disabled selected>Selecione um cliente...</option>';
                state.clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.nome;
                    agendamentoClienteSelect.appendChild(option);
                });
            }
            
            /**
             * Popula o select de serviços no formulário de agendamento
             */
            function populateServicoSelect() {
                agendamentoServicoSelect.innerHTML = '<option value="" disabled selected>Selecione um serviço...</option>';
                state.servicos.forEach(servico => {
                    const option = document.createElement('option');
                    option.value = servico.id;
                    option.textContent = `${servico.nome} (${formatCurrency(servico.preco)})`;
                    agendamentoServicoSelect.appendChild(option);
                });
            }

            // --- GERENCIAMENTO DE AGENDAMENTOS ---

            /**
             * Adiciona um serviço à lista temporária do agendamento
             */
            function handleAddServico() {
                const servicoId = agendamentoServicoSelect.value;
                if (!servicoId) return;
                
                if (tempAgendamentoServicos.find(s => s.id === servicoId)) {
                    showModal('Serviço Duplicado', 'Este serviço já foi adicionado.', () => {});
                    agendamentoServicoSelect.value = '';
                    return;
                }

                const servico = state.servicos.find(s => s.id === servicoId);
                if (servico) {
                    tempAgendamentoServicos.push({ id: servico.id, nome: servico.nome, valor: servico.preco });
                    renderTempServicosList();
                    updateValorFinal();
                    agendamentoServicoSelect.value = '';
                    agendamentoServicosError.classList.add('hidden');
                }
            }
            
            /**
             * Remove um serviço da lista temporária
             */
            function handleRemoveServico(e) {
                const removeBtn = e.target.closest('.remove-temp-servico');
                if (removeBtn) {
                    const servicoId = removeBtn.dataset.id;
                    tempAgendamentoServicos = tempAgendamentoServicos.filter(s => s.id !== servicoId);
                    renderTempServicosList();
                    updateValorFinal();
                }
            }
            
            /**
             * Renderiza a lista de serviços temporários
             */
            function renderTempServicosList() {
                agendamentoServicosList.innerHTML = '';
                if (tempAgendamentoServicos.length === 0) {
                    agendamentoServicosList.innerHTML = '<li class="text-center text-sm text-pastel-text-light">Nenhum serviço adicionado.</li>';
                    return;
                }
                
                tempAgendamentoServicos.forEach(servico => {
                    const item = document.createElement('li');
                    item.className = 'flex items-center justify-between rounded-lg bg-primary-50 p-2';
                    item.innerHTML = `
                        <div>
                            <p class="font-medium text-pastel-text">${servico.nome}</p>
                            <p class="text-sm text-primary-600">${formatCurrency(servico.valor)}</p>
                        </div>
                        <button type="button" data-id="${servico.id}" class="remove-temp-servico rounded-full p-1 text-red-500 transition hover:bg-red-100">
                            <i data-lucide="x" class="h-4 w-4"></i>
                        </button>
                    `;
                    agendamentoServicosList.appendChild(item);
                });
                lucide.createIcons();
            }

            /**
             * Atualiza o valor final do agendamento com base nos serviços e desconto
             */
            function updateValorFinal() {
                const valorBruto = tempAgendamentoServicos.reduce((acc, servico) => acc + servico.valor, 0);
                const desconto = parseFloat(agendamentoDescontoInput.value) || 0;
                const tipoDesconto = agendamentoDescontoTipoSelect.value;
                
                let valorDesconto = 0;
                if (tipoDesconto === 'dinheiro') {
                    valorDesconto = desconto;
                } else if (tipoDesconto === 'porcentagem') {
                    valorDesconto = (valorBruto * desconto) / 100;
                }
                
                const valorFinal = Math.max(0, valorBruto - valorDesconto);
                agendamentoValorFinal.textContent = formatCurrency(valorFinal);
            }
            
            /**
             * Reseta o formulário de agendamento
             */
            function resetAgendamentoForm() {
                agendamentoForm.reset();
                tempAgendamentoServicos = [];
                editAgendamentoId = null;
                agendamentoEditIdInput.value = '';
                renderTempServicosList();
                updateValorFinal();
                agendamentoServicosError.classList.add('hidden');
                cancelEditBtn.classList.add('hidden');
                populateClienteSelect();
                populateServicoSelect();
            }

            /**
             * Lida com o submit do formulário de agendamento (Salvar ou Editar)
             */
            function handleAgendamentoSubmit(e) {
                e.preventDefault();
                
                if (tempAgendamentoServicos.length === 0) {
                    agendamentoServicosError.classList.remove('hidden');
                    return;
                }
                agendamentoServicosError.classList.add('hidden');
                
                const clienteId = agendamentoClienteSelect.value;
                const cliente = state.clientes.find(c => c.id === clienteId);
                const data = agendamentoDataInput.value;
                const descontoInput = parseFloat(agendamentoDescontoInput.value) || 0;
                const descontoTipo = agendamentoDescontoTipoSelect.value;

                const valorBruto = tempAgendamentoServicos.reduce((acc, s) => acc + s.valor, 0);
                
                let valorDesconto = 0;
                if (descontoTipo === 'dinheiro') {
                    valorDesconto = descontoInput;
                } else if (descontoTipo === 'porcentagem') {
                    valorDesconto = (valorBruto * descontoInput) / 100;
                }
                
                const valorFinal = Math.max(0, valorBruto - valorDesconto);

                const agendamento = {
                    id: editAgendamentoId || generateId(),
                    clienteId: cliente.id,
                    clienteNome: cliente.nome, // Salva o nome para referência rápida
                    data: data,
                    servicos: [...tempAgendamentoServicos], // Copia o array
                    valorBruto: valorBruto,
                    desconto: valorDesconto,
                    descontoInput: descontoInput,
                    descontoTipo: descontoTipo,
                    valorFinal: valorFinal,
                    status: 'agendado'
                };
                
                if (editAgendamentoId) {
                    const index = state.agendamentos.findIndex(ag => ag.id === editAgendamentoId);
                    if (index !== -1) {
                        const statusAntigo = state.agendamentos[index].status;
                        if (statusAntigo === 'concluido' || statusAntigo === 'cancelado') {
                            agendamento.status = statusAntigo;
                        }
                        state.agendamentos[index] = agendamento;
                    }
                } else {
                    state.agendamentos.push(agendamento);
                }
                
                state.agendamentos.sort((a, b) => new Date(a.data) - new Date(b.data));
                saveState();
                resetAgendamentoForm();
                showPage('inicio');
            }

            /**
             * Prepara o formulário para editar um agendamento
             */
            function fillFormForEdit(agendamento) {
                editAgendamentoId = agendamento.id;
                agendamentoEditIdInput.value = agendamento.id;
                
                agendamentoClienteSelect.value = agendamento.clienteId;
                agendamentoDataInput.value = formatDateTimeForInput(agendamento.data);
                agendamentoDescontoInput.value = agendamento.descontoInput || 0;
                agendamentoDescontoTipoSelect.value = agendamento.descontoTipo || 'dinheiro';
                
                tempAgendamentoServicos = [...agendamento.servicos];
                renderTempServicosList();
                updateValorFinal();
                
                cancelEditBtn.classList.remove('hidden');
                
                showPage('agendar');
                pageTitle.textContent = "Editar Agendamento";
            }
            
            /**
             * Renderiza o dashboard (Início)
             */
            function renderDashboard() {
                dashboardPendentes.innerHTML = '';
                dashboardHistorico.innerHTML = '';
                
                if (state.agendamentos.length === 0) {
                    dashboardPendentes.innerHTML = '<p class="text-center text-pastel-text-light">Nenhum agendamento pendente.</p>';
                    dashboardHistorico.innerHTML = '<p class="text-center text-pastel-text-light">Nenhum histórico de agendamentos.</p>';
                    return;
                }
                
                const agora = new Date();
                let pendentesCount = 0;
                let historicoCount = 0;
                
                const pendentes = [];
                const historico = [];
                
                state.agendamentos.forEach(ag => {
                    if (ag.status === 'agendado') {
                        pendentes.push(ag);
                    } else {
                        historico.push(ag);
                    }
                });
                
                pendentes.sort((a, b) => new Date(a.data) - new Date(b.data));
                historico.sort((a, b) => new Date(b.data) - new Date(a.data));
                
                // Renderiza Pendentes
                pendentes.forEach(ag => {
                    pendentesCount++;
                    const cliente = state.clientes.find(c => c.id === ag.clienteId) || { nome: 'Cliente Apagado' };
                    const item = document.createElement('div');
                    item.className = 'rounded-lg bg-pastel-card p-4 shadow-sm';
                    
                    const dataAg = new Date(ag.data);
                    const isAtrasado = dataAg < agora;
                    
                    const servicosHtml = ag.servicos.map(s => `
                        <li class="text-sm text-pastel-text-light">${s.nome}</li>
                    `).join('');

                    item.innerHTML = `
                        <div class="flex flex-col justify-between sm:flex-row">
                            <div>
                                <p class="font-bold text-pastel-text">${cliente.nome}</p>
                                <ul class="ml-4 mt-1 list-disc">${servicosHtml}</ul>
                                <p class="mt-2 text-sm font-semibold ${isAtrasado ? 'text-red-600' : 'text-secondary-600'}">
                                    <i data-lucide="clock" class="mr-1 inline h-4 w-4"></i>
                                    ${formatDateTime(ag.data)} (${isAtrasado ? 'Atrasado' : 'Agendado'})
                                </p>
                            </div>
                            <div class="mt-2 flex-shrink-0 sm:mt-0">
                                <p class="text-right text-lg font-bold text-primary-600 sm:text-left">${formatCurrency(ag.valorFinal)}</p>
                            </div>
                        </div>
                        <div class="mt-4 flex flex-wrap gap-2 border-t border-gray-100 pt-3">
                            <button data-id="${ag.id}" class="concluir-ag btn-sm flex-1 bg-green-500 hover:bg-green-600">
                                <i data-lucide="check" class="mr-1 h-4 w-4"></i> Concluir
                            </button>
                            <button data-id="${ag.id}" class="editar-ag btn-sm flex-1 bg-blue-500 hover:bg-blue-600">
                                <i data-lucide="edit" class="mr-1 h-4 w-4"></i> Editar
                            </button>
                            <button data-id="${ag.id}" class="cancelar-ag btn-sm flex-1 bg-red-500 hover:bg-red-600">
                                <i data-lucide="x" class="mr-1 h-4 w-4"></i> Cancelar
                            </button>
                            <button data-id="${ag.id}" class="gerar-pdf btn-sm flex-1 bg-gray-600 hover:bg-gray-700">
                                <i data-lucide="download" class="mr-1 h-4 w-4"></i> PDF
                            </button>
                        </div>
                    `;
                    dashboardPendentes.appendChild(item);
                });
                
                // Renderiza Histórico
                historico.forEach(ag => {
                    historicoCount++;
                    const cliente = state.clientes.find(c => c.id === ag.clienteId) || { nome: 'Cliente Apagado' };
                    
                    let statusHtml = '';
                    if (ag.status === 'concluido') {
                        statusHtml = `<span class="font-bold text-green-600">Concluído</span>`;
                    } else if (ag.status === 'cancelado') {
                        statusHtml = `<span class="font-bold text-red-600">Cancelado</span>`;
                    }
                    
                    const servicosHtml = ag.servicos.map(s => `
                        <li class="text-sm text-pastel-text-light">${s.nome}</li>
                    `).join('');

                    const item = document.createElement('div');
                    item.className = 'rounded-lg bg-pastel-card p-4 shadow-sm opacity-80';
                    item.innerHTML = `
                        <div class="flex flex-col justify-between sm:flex-row">
                            <div>
                                <p class="font-bold text-pastel-text">${cliente.nome}</p>
                                <ul class="ml-4 mt-1 list-disc">${servicosHtml}</ul>
                                <p class="mt-2 text-sm text-pastel-text-light">
                                    <i data-lucide="clock" class="mr-1 inline h-4 w-4"></i>
                                    ${formatDateTime(ag.data)}
                                </p>
                            </div>
                            <div class="mt-2 flex-shrink-0 sm:mt-0">
                                <p class="text-right text-lg font-bold text-primary-600 sm:text-left">${formatCurrency(ag.valorFinal)}</p>
                                <p class="mt-1 text-right text-sm sm:text-left">${statusHtml}</p>
                            </div>
                        </div>
                        <div class="mt-4 flex flex-wrap gap-2 border-t border-gray-100 pt-3">
                            <button data-id="${ag.id}" class="gerar-pdf btn-sm flex-1 bg-gray-600 hover:bg-gray-700">
                                <i data-lucide="download" class="mr-1 h-4 w-4"></i> PDF
                            </button>
                        </div>
                    `;
                    dashboardHistorico.appendChild(item);
                });

                if (pendentesCount === 0) {
                    dashboardPendentes.innerHTML = '<p class="text-center text-pastel-text-light">Nenhum agendamento pendente.</p>';
                }
                if (historicoCount === 0) {
                    dashboardHistorico.innerHTML = '<p class="text-center text-pastel-text-light">Nenhum histórico de agendamentos.</p>';
                }

                lucide.createIcons();
                
                // Adiciona o estilo para os botões de ação
                const styleSheet = document.createElement("style");
                styleSheet.type = "text/css";
                styleSheet.innerText = `
                    .btn-sm {
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 6px 10px;
                        font-size: 0.8rem;
                        font-weight: bold;
                        color: white;
                        border-radius: 6px;
                        transition: background-color 0.2s;
                        min-width: 100px;
                    }
                `;
                document.head.appendChild(styleSheet);
            }
            
            /**
             * Lida com cliques nos botões do dashboard
             */
            function handleDashboardListClick(e) {
                const target = e.target.closest('button');
                if (!target) return;
                
                const id = target.dataset.id;
                const agendamento = state.agendamentos.find(ag => ag.id === id);
                if (!agendamento) return;
                
                if (target.classList.contains('concluir-ag')) {
                    showModal('Concluir Agendamento', 'Deseja marcar este agendamento como concluído?', () => {
                        agendamento.status = 'concluido';
                        saveState();
                        renderDashboard();
                    });
                } else if (target.classList.contains('cancelar-ag')) {
                    showModal('Cancelar Agendamento', 'Deseja cancelar este agendamento?', () => {
                        agendamento.status = 'cancelado';
                        saveState();
                        renderDashboard();
                    });
                } else if (target.classList.contains('editar-ag')) {
                    fillFormForEdit(agendamento);
                } else if (target.classList.contains('gerar-pdf')) {
                    generatePDFComprovante(agendamento);
                }
            }
            
            // --- GERENCIAMENTO DE CAIXA (NOVO) ---
            
            /**
             * Popula o select de produtos no Caixa
             */
            function populateCaixaProdutoSelect() {
                caixaProdutoSelect.innerHTML = '<option value="" disabled selected>Selecione um produto...</option>';
                state.estoque.filter(p => p.qtd > 0).forEach(produto => { // Só mostra produtos com estoque
                    const option = document.createElement('option');
                    option.value = produto.id;
                    option.textContent = `${produto.nome} (${formatCurrency(produto.preco)}) - ${produto.qtd} disp.`;
                    caixaProdutoSelect.appendChild(option);
                });
            }
            
            /**
             * Adiciona um item ao carrinho do Caixa
             */
            function handleCaixaAdd() {
                const produtoId = caixaProdutoSelect.value;
                const qtd = parseInt(caixaQtdInput.value);
                if (!produtoId || !qtd || qtd <= 0) return;
                
                const produto = state.estoque.find(p => p.id === produtoId);
                if (!produto) return;
                
                const itemExistente = tempVendaItens.find(item => item.id === produtoId);
                const qtdTotal = (itemExistente ? itemExistente.qtd : 0) + qtd;
                
                // Verifica estoque
                if (qtdTotal > produto.qtd) {
                    caixaEstoqueError.textContent = `Estoque insuficiente. Disponível: ${produto.qtd}`;
                    caixaEstoqueError.classList.remove('hidden');
                    return;
                }
                caixaEstoqueError.classList.add('hidden');
                
                if (itemExistente) {
                    itemExistente.qtd = qtdTotal;
                    itemExistente.valorTotal = itemExistente.valorUnitario * qtdTotal;
                } else {
                    tempVendaItens.push({
                        id: produto.id,
                        nome: produto.nome,
                        qtd: qtd,
                        valorUnitario: produto.preco,
                        valorTotal: produto.preco * qtd
                    });
                }
                
                renderCaixaList();
                updateCaixaTotal();
                
                // Reseta inputs
                caixaProdutoSelect.value = '';
                caixaQtdInput.value = 1;
            }
            
            /**
             * Remove um item do carrinho do Caixa
             */
            function handleCaixaRemove(e) {
                const removeBtn = e.target.closest('.remove-caixa-item');
                if (removeBtn) {
                    const produtoId = removeBtn.dataset.id;
                    tempVendaItens = tempVendaItens.filter(item => item.id !== produtoId);
                    renderCaixaList();
                    updateCaixaTotal();
                }
            }
            
            /**
             * Renderiza a lista do carrinho do Caixa
             */
            function renderCaixaList() {
                caixaItensList.innerHTML = '';
                if (tempVendaItens.length === 0) {
                    caixaItensList.innerHTML = '<li class="text-center text-sm text-pastel-text-light">Nenhum produto adicionado.</li>';
                    return;
                }
                
                tempVendaItens.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between rounded-lg bg-primary-50 p-2';
                    li.innerHTML = `
                        <div>
                            <p class="font-medium text-pastel-text">${item.qtd}x ${item.nome}</p>
                            <p class="text-sm text-primary-600">${formatCurrency(item.valorTotal)}</p>
                        </div>
                        <button type="button" data-id="${item.id}" class="remove-caixa-item rounded-full p-1 text-red-500 transition hover:bg-red-100">
                            <i data-lucide="x" class="h-4 w-4"></i>
                        </button>
                    `;
                    caixaItensList.appendChild(li);
                });
                lucide.createIcons();
            }
            
            /**
             * Atualiza o valor total do carrinho do Caixa
             */
            function updateCaixaTotal() {
                const total = tempVendaItens.reduce((acc, item) => acc + item.valorTotal, 0);
                caixaValorFinal.textContent = formatCurrency(total);
            }
            
            /**
             * Reseta o formulário do Caixa
             */
            function resetCaixaForm() {
                caixaForm.reset();
                tempVendaItens = [];
                renderCaixaList();
                updateCaixaTotal();
                populateCaixaProdutoSelect();
                caixaEstoqueError.classList.add('hidden');
            }
            
            /**
             * Finaliza a Venda do Caixa
             */
            function handleFinalizarVenda(e) {
                e.preventDefault();
                if (tempVendaItens.length === 0) {
                    showModal('Carrinho Vazio', 'Adicione pelo menos um produto para finalizar a venda.', () => {});
                    return;
                }
                
                const valorTotal = tempVendaItens.reduce((acc, item) => acc + item.valorTotal, 0);
                
                const novaVenda = {
                    id: generateId(),
                    data: new Date().toISOString(),
                    itens: [...tempVendaItens],
                    valorTotal: valorTotal
                };
                
                // Abate do estoque
                try {
                    novaVenda.itens.forEach(itemVendido => {
                        const produtoEstoque = state.estoque.find(p => p.id === itemVendido.id);
                        if (!produtoEstoque) throw new Error(`Produto ${itemVendido.nome} não encontrado no estoque.`);
                        if (produtoEstoque.qtd < itemVendido.qtd) throw new Error(`Estoque insuficiente para ${itemVendido.nome}.`);
                        
                        produtoEstoque.qtd -= itemVendido.qtd;
                    });
                } catch (error) {
                    console.error("Erro ao abater do estoque:", error);
                    showModal('Erro de Estoque', `Não foi possível finalizar a venda: ${error.message}`, () => {});
                    return;
                }
                
                // Salva a venda e o estoque atualizado
                state.vendas.push(novaVenda);
                saveState();
                
                // Renderiza estoque (para atualizar a lista de produtos na página de estoque)
                renderEstoque();
                
                // Mostra modal de sucesso
                showVendaSuccessModal(novaVenda);
                
                // Limpa o formulário
                resetCaixaForm();
            }

            
            // --- RELATÓRIOS ---
            
            /**
             * Renderiza a página de Relatórios
             */
            function renderRelatorios() {
                // Seta as datas padrão (início do mês e hoje)
                const hoje = new Date();
                const inicioDoMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                relatorioInicioInput.value = formatDateForInput(inicioDoMes);
                relatorioFimInput.value = formatDateForInput(hoje);
                
                // Limpa resultados anteriores
                relatorioResultado.classList.add('hidden');
                
                // Renderiza o Ranking Anual
                renderRankingAnual();
            }
            
            /**
             * Renderiza o Relatório por Período
             */
            function renderRelatorioPeriodo() {
                const inicioStr = relatorioInicioInput.value;
                const fimStr = relatorioFimInput.value;
                
                if (!inicioStr || !fimStr) {
                    showModal('Datas Inválidas', 'Por favor, selecione uma data de início e uma data de fim.', () => {});
                    return;
                }
                
                const inicio = new Date(inicioStr + 'T00:00:00');
                const fim = new Date(fimStr + 'T23:59:59');
                
                if (fim < inicio) {
                    showModal('Datas Inválidas', 'A data de fim deve ser posterior à data de início.', () => {});
                    return;
                }
                
                // Ganhos de Agendamentos
                const agendamentosFiltrados = state.agendamentos.filter(ag => {
                    const dataAg = new Date(ag.data);
                    return ag.status === 'concluido' && dataAg >= inicio && dataAg <= fim;
                });
                const totalAgendamentos = agendamentosFiltrados.reduce((total, ag) => total + ag.valorFinal, 0);
                
                // Ganhos de Vendas (Caixa)
                const vendasFiltradas = state.vendas.filter(v => {
                    const dataVenda = new Date(v.data);
                    return dataVenda >= inicio && dataVenda <= fim;
                });
                const totalVendas = vendasFiltradas.reduce((total, v) => total + v.valorTotal, 0);
                
                // Total Faturado
                const totalFaturado = totalAgendamentos + totalVendas;
                
                // Exibe os resultados
                relatorioPeriodo.textContent = `${formatDate(inicio)} - ${formatDate(fim)}`;
                relatorioAgendamentos.textContent = `${agendamentosFiltrados.length} (${formatCurrency(totalAgendamentos)})`;
                relatorioVendas.textContent = `${vendasFiltradas.length} (${formatCurrency(totalVendas)})`;
                relatorioTotal.textContent = formatCurrency(totalFaturado);
                relatorioResultado.classList.remove('hidden');
            }
            
            /**
             * Renderiza o Ranking Anual de Clientes
             */
            function renderRankingAnual() {
                const hoje = new Date();
                const anoAtual = hoje.getFullYear();
                rankingAno.textContent = `Baseado em agendamentos concluídos de 01/01/${anoAtual} a 31/12/${anoAtual}.`;
                
                const inicioAno = new Date(anoAtual, 0, 1); // 1 de Janeiro
                const fimAno = new Date(anoAtual, 11, 31, 23, 59, 59); // 31 de Dezembro
                
                const agendamentosAno = state.agendamentos.filter(ag => {
                    const dataAg = new Date(ag.data);
                    return ag.status === 'concluido' && dataAg >= inicioAno && dataAg <= fimAno;
                });
                
                // Conta agendamentos por cliente
                const contagemClientes = new Map();
                agendamentosAno.forEach(ag => {
                    const contagem = contagemClientes.get(ag.clienteId) || 0;
                    contagemClientes.set(ag.clienteId, contagem + 1);
                });
                
                const ranking = Array.from(contagemClientes.entries())
                    .map(([clienteId, contagem]) => {
                        const cliente = state.clientes.find(c => c.id === clienteId);
                        return {
                            id: clienteId,
                            nome: cliente ? cliente.nome : 'Cliente Apagado',
                            contagem: contagem
                        };
                    })
                    .sort((a, b) => b.contagem - a.contagem); // Ordena do maior para o menor
                    
                rankingLista.innerHTML = '';
                if (ranking.length === 0) {
                    rankingLista.innerHTML = '<p class="text-center text-pastel-text-light">Nenhum agendamento concluído este ano.</p>';
                    return;
                }
                
                ranking.forEach((cliente, index) => {
                    let medalha = '';
                    if (index === 0) medalha = '🥇';
                    else if (index === 1) medalha = '🥈';
                    else if (index === 2) medalha = '🥉';
                
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between rounded-lg bg-primary-50 p-3';
                    item.innerHTML = `
                        <div class="flex items-center">
                            <span class="mr-3 w-6 text-lg font-bold ${index < 3 ? '' : 'text-pastel-text-light'}">
                                ${medalha || (index + 1) + '.'}
                            </span>
                            <p class="font-medium text-pastel-text">${cliente.nome}</p>
                        </div>
                        <span class="font-bold text-primary-600">${cliente.contagem} ${cliente.contagem > 1 ? 'serviços' : 'serviço'}</span>
                    `;
                    rankingLista.appendChild(item);
                });
            }

            // --- BACKUP E RESTAURAÇÃO ---

            /**
             * Lida com o clique no botão de backup
             */
            function handleBackup() {
                const dataStr = JSON.stringify(state);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                const data = new Date();
                const dataFormatada = `${data.getFullYear()}-${data.getMonth()+1}-${data.getDate()}`;
                link.download = `pd_gestao_backup_${dataFormatada}.json`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            /**
             * Lida com a seleção de um arquivo de restauração
             */
            function handleRestore(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        let newState = JSON.parse(event.target.result);
                        
                        // **IMPORTANTE**: Migra os dados do backup, se necessário
                        newState = migrateData(newState);
                        
                        // Validação básica
                        if (newState.servicos && newState.estoque && newState.agendamentos && newState.clientes) {
                            showModal('Restaurar Backup', 'Tem certeza? TODOS os dados atuais serão apagados e substituídos pelo backup.', () => {
                                state = newState;
                                saveState();
                                // Recarrega tudo
                                renderDashboard();
                                renderServicos();
                                renderEstoque();
                                renderClientes();
                                renderAniversarios();
                                showPage('inicio');
                                showModal('Sucesso', 'Backup restaurado com sucesso.', () => {});
                            });
                        } else {
                            showModal('Erro', 'Arquivo de backup inválido ou corrompido.', () => {});
                        }
                    } catch (error) {
                        console.error("Erro ao ler o backup:", error);
                        showModal('Erro', 'Não foi possível ler o arquivo. Ele pode estar corrompido.', () => {});
                    } finally {
                        restoreInput.value = '';
                    }
                };
                reader.readAsText(file);
            }
            
            // --- GERAÇÃO DE PDF ---
            
            /**
             * Gera o PDF de comprovante (Design "Chique")
             */
            function generatePDFComprovante(agendamento) {
                try {
                    const doc = new jsPDF();
                    const cliente = state.clientes.find(c => c.id === agendamento.clienteId) || { nome: 'Cliente Apagado' };
                    
                    const corPrincipal = '#C52A35';
                    const corTexto = '#5C4033';
                    const corTextoClaro = '#8C7A6B';
                    const corFundoCaixa = '#FFF8F9';
                    const corSecundaria = '#6D28D9';
                    
                    doc.setFillColor(corPrincipal);
                    doc.rect(0, 0, 210, 30, 'F');
                    doc.setFontSize(22);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor('#FFFFFF');
                    doc.text('PD Gestão', 20, 19);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text('COMPROVANTE DE AGENDAMENTO', 105, 25, { align: 'center' });

                    let y = 45;
                    const xLabel = 20;
                    const xValor = 70;
                    
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(corSecundaria);
                    
                    doc.text('CLIENTE:', xLabel, y);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(corTexto);
                    doc.text(cliente.nome, xValor, y);
                    y += 10;
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(corSecundaria);
                    doc.text('DATA E HORA:', xLabel, y);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(corTexto);
                    doc.text(formatDateTime(agendamento.data), xValor, y);
                    y += 10;
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(corSecundaria);
                    doc.text('SERVIÇOS:', xLabel, y);
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(corTexto);
                    agendamento.servicos.forEach(servico => {
                        doc.text(`- ${servico.nome} (${formatCurrency(servico.valor)})`, xValor, y);
                        y += 7;
                    });
                    
                    y += 3;
                    y += 5;
                    doc.setDrawColor(corTextoClaro);
                    doc.line(20, y - 5, 190, y - 5);
                    
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(corTexto);
                    
                    if (agendamento.desconto > 0) {
                        doc.text('Subtotal:', 140, y);
                        doc.text(formatCurrency(agendamento.valorBruto), 190, y, { align: 'right' });
                        y += 7;
                        
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(corTextoClaro);
                        doc.text('Desconto:', 140, y);
                        doc.text(`- ${formatCurrency(agendamento.desconto)}`, 190, y, { align: 'right' });
                        y += 7;
                    }
                    
                    // --- CORREÇÃO DO PDF ---
                    // Alinha o texto do label à direita (x=150) e o valor à direita (x=190)
                    // Isso evita a sobreposição que você mencionou.
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(corPrincipal);
                    doc.text('VALOR TOTAL:', 150, y, { align: 'right' }); // Label alinhado à direita
                    
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text(formatCurrency(agendamento.valorFinal), 190, y, { align: 'right' }); // Valor alinhado à direita
                    
                    y += 20;
                    doc.setFillColor(corFundoCaixa);
                    doc.roundedRect(20, y, 170, 25, 3, 3, 'F');
                    
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(corPrincipal);
                    doc.text('Obrigada pela preferência!', 105, y + 10, { align: 'center' });
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(corTextoClaro);
                    doc.text('Estamos ansiosas para te receber no estúdio.', 105, y + 16, { align: 'center' });

                    const dataGeracao = new Date().toLocaleString('pt-BR');
                    doc.setFontSize(8);
                    doc.setTextColor(corTextoClaro);
                    doc.text(`Gerado em: ${dataGeracao}`, 20, 290);
                    
                    const nomeArquivo = `agendamento_${cliente.nome.split(' ')[0]}_${new Date(agendamento.data).toISOString().split('T')[0]}.pdf`;
                    doc.save(nomeArquivo);

                } catch (error) {
                    console.error("Erro ao gerar PDF:", error);
                    showModal('Erro no PDF', 'Não foi possível gerar o PDF. Verifique o console.', () => {});
                }
            }
            
            /**
             * Gera o PDF de Recibo de Venda (Caixa)
             */
            function generatePDFVenda(venda) {
                try {
                    const doc = new jsPDF();
                    
                    const corPrincipal = '#C52A35';
                    const corTexto = '#5C4033';
                    const corTextoClaro = '#8C7A6B';
                    
                    doc.setFillColor(corPrincipal);
                    doc.rect(0, 0, 210, 30, 'F');
                    doc.setFontSize(22);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor('#FFFFFF');
                    doc.text('PD Gestão', 20, 19);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text('RECIBO DE VENDA', 105, 25, { align: 'center' });

                    let y = 45;
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(corTexto);
                    doc.text(`Data: ${formatDateTime(venda.data)}`, 20, y);
                    y += 10;
                    
                    doc.setDrawColor(corTextoClaro);
                    doc.line(20, y, 190, y); // Linha
                    y += 10;

                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('QTD', 20, y);
                    doc.text('PRODUTO', 40, y);
                    doc.text('V. UN.', 150, y, { align: 'right' });
                    doc.text('V. TOTAL', 190, y, { align: 'right' });
                    y += 7;
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(corTexto);
                    venda.itens.forEach(item => {
                        doc.text(String(item.qtd), 20, y);
                        doc.text(item.nome, 40, y);
                        doc.text(formatCurrency(item.valorUnitario), 150, y, { align: 'right' });
                        doc.text(formatCurrency(item.valorTotal), 190, y, { align: 'right' });
                        y += 7;
                    });
                    
                    y += 5;
                    doc.line(20, y, 190, y); // Linha
                    y += 7;
                    
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(corPrincipal);
                    doc.text('VALOR TOTAL:', 150, y, { align: 'right' });
                    doc.text(formatCurrency(venda.valorTotal), 190, y, { align: 'right' });
                    
                    y += 20;
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(corTexto);
                    doc.text('Obrigada pela sua compra!', 105, y, { align: 'center' });
                    
                    const dataGeracao = new Date().toLocaleString('pt-BR');
                    doc.setFontSize(8);
                    doc.setTextColor(corTextoClaro);
                    doc.text(`Gerado em: ${dataGeracao}`, 20, 290);
                    
                    const nomeArquivo = `venda_${venda.id}.pdf`;
                    doc.save(nomeArquivo);

                } catch (error) {
                    console.error("Erro ao gerar PDF da Venda:", error);
                    showModal('Erro no PDF', 'Não foi possível gerar o PDF. Verifique o console.', () => {});
                }
            }
            
            /**
             * Gera HTML para Impressora Térmica e chama a impressão
             */
            function printThermalReceipt(venda) {
                let html = `
                    <h3 style="text-align: center; font-size: 1.2em; margin-bottom: 10px;">PD Gestão</h3>
                    <p style="text-align: center; font-size: 0.9em; margin-bottom: 5px;">RECIBO DE VENDA</p>
                    <p style="font-size: 0.8em; margin-bottom: 10px;">Data: ${formatDateTime(venda.data)}</p>
                    <hr style="border-top: 1px dashed #000; margin-bottom: 10px;">
                `;
                
                venda.itens.forEach(item => {
                    html += `
                        <div style="font-size: 0.9em;">
                            <p style="margin: 0;">${item.nome}</p>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="margin-left: 10px;">${item.qtd} x ${formatCurrency(item.valorUnitario)}</span>
                                <span>${formatCurrency(item.valorTotal)}</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `<hr style="border-top: 1px dashed #000; margin-top: 10px; margin-bottom: 10px;">`;
                html += `
                    <div style="display: flex; justify-content: space-between; font-size: 1.1em; font-weight: bold; margin-bottom: 20px;">
                        <span>TOTAL:</span>
                        <span>${formatCurrency(venda.valorTotal)}</span>
                    </div>
                `;
                html += `<p style="text-align: center; font-size: 0.9em;">Obrigada pela sua compra!</p>`;
                
                receiptPrintArea.innerHTML = html;
                window.print();
            }
            
            
            // --- INICIALIZAÇÃO ---
            init();
        };
    </script>
</body>
</html>
